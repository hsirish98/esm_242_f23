---
title: "HW_3"
author: "Andrew Plantinga"
date: "2023-10-24"
output:
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r}
library(tidyverse)
library(nloptr)
library(knitr)
```

## Question 1: Forestry Rotation {.tabset}

This problem expands on the forest rotation problem presented in class.  Suppose that a stand of trees is planted in time 0 at a cost of c, grown for $T_1$ years, harvested, replanted at cost c, grown for $T_2$ years, harvested, replanted, and so on.  If we complete six rotations, what should be the values of $T_1$, $T_2$, $T_3$, $T_4$, $T_5$, and $T_6$?  Assume that different values can be chosen for each year and that the stand does not need to be replanted after the sixth harvest.  Use the parameter values a=10, b=53.27, c=250, p=1.5, and $\delta$=0.05.

### A.

Before you solve the problem for six rotations, find the optimal rotation when only one rotation is done.  What is the optimal value of $T_1$?



```{r}
obj_func <- function(choice, a, b, c, p, delta, rotations){
  ##initialize benefit and state vectors to amount of rotations+1 (to include t=0)
   bens = vector(mode="numeric",length=(rotations+1))
   state = vector(mode="numeric", length=(rotations+1))
   
   ##initial state (discounting time) is 0, benefits are the costs from planting trees
   state[1] = 0
   bens[1] = -c

   ##second state is initial state (0) plus the choice that's maximized
   state[2] = state[1] + choice
   bens[2] = p*exp(a-(b/choice)) ##benefits are the price *Q(this time period/state[2]) with NO c subtracted
   
   rho = (1/(1+delta))
   pv = bens*(rho^state)
   npv = sum(pv)
   return(-npv)
}
```

```{r}


options=list("algorithm"="NLOPT_LN_COBYLA",xtol_rel=1e-8,maxeval=16000)

 out_1a=nloptr(x0=1,eval_f=obj_func,
              lb=0,
              opts = options, 
              a=10, b=53.27, c=250, p=1.5, delta=0.05, rotations=1)
 
 obj_1a = -out_1a$objective

 print(out_1a$solution)
 
```

PVNB is maximized to $`r format(obj_1a, scientific=FALSE)`

The optimal rotation length would be `r round(out_1a$solution, 2)` years

### B. 

Now solve the problem for six consecutive rotations.  What are the six rotation lengths that you found?

<span style="color: blue;">**Solution**
</span>



```{r}

obj_func <- function(choice, a, b, c, p, delta, rotations){
   bens = vector(mode="numeric",length=(rotations+1))
   state = vector(mode="numeric", length=(rotations+1))
   
   state[1] = 0
   bens[1] = -c

    ##this time, update state everything to state from period before + the new optimized rotation length
   
  for(i in 2:(rotations+1)){ ##until the second to last time (first item in vector is time = 0 and next is time = 1 so I'm going to time = 5 or the 6th item in the vector, using rotations=6)
   state[i] = state[i-1] + choice[i] 
   bens[i] = p*exp(a-(b/choice[i])) - (ifelse(i==(rotations+1), 0, c))
  }
   # state[rotations+1] = state[rotations] + choice[rotations+1] ##last one 
   # bens[rotations+1] = p*exp(a-(b/choice[rotations+1])) 
   # 
   rho = (1/(1+delta))
   pv = bens*(rho^state)
   npv = sum(pv)
   return(-npv)
}


```

```{r}
options=list("algorithm"="NLOPT_LN_COBYLA",xtol_rel=1e-8,maxeval=16000)


out_1b <- nloptr(x0=rep(1, times=7),eval_f=obj_func,
              lb=rep(0,times=7),
              opts = options, 
              a=10, b=53.27, c=250, p=1.5, delta=0.05, rotations=6)
 
 obj_1b = -out_1b$objective

 print(out_1b$solution)
```

PVNB is maximized to $`r format(obj_1b, scientific=FALSE)`

The optimal rotation length would be `r round(out_1b$solution, 2)` years



### C.

Explain why $T_1$ through $T_5$ are shorter than $T_6$?

<span style="color: blue;">**Solution**
</span>

<span style="color: blue;">

</span>

### D.

What happens to $T_1$ through $T_5$ when the cost of replanting the stand increases to 500? Explain. Why doesn't $T_6$ change with the higher replanting cost?


<span style="color: blue;">**Solution**
</span>

<span style="color: blue;">


</span>


```{r}
options=list("algorithm"="NLOPT_LN_COBYLA",xtol_rel=1e-8,maxeval=16000)



out_1d <- nloptr(x0=rep(1, times=7),eval_f=obj_func,
              lb=rep(0,times=7),
              opts = options, 
              a=10, b=53.27, c=500, p=1.5, delta=0.05, rotations=6)
 
 obj_1d = -out_1d$objective

 print(out_1d$solution)

```

### E.

Compare your answer to part a (the single rotation) to $T_6$. Why are they the same?

<span style="color: blue;">**Solution**
</span>

<span style="color: blue;">


</span>


### F

Now solve for the optimal rotation when an infinite number of rotations are done.  Compute the present value of net revenues (i.e., $objective).  Compare this to the present value of net revenues when only six rotations are done.  Are they close in magnitude?  Why?

```{r}

```



## Question 2: Varying Initial Age {.tabset}

In this problem, you are asked to find the optimal rotation when the initial age of the stand is not zero.  The key question is whether a positive initial age should change the solution.  That is, if T* is the optimal rotation age for a stand starting at age 0, will it still be the same optimal rotation age for a stand starting at age $A$>0?  The volume of timber evolves according to $Q(T)=e^{a-b/T}$  where a=13, b=185, and T is the age of the trees. The price of timber is p=1.78 and the cost of planting the stand at the start of each rotation is 1000.  The discount rate is $\delta$=0.05.  

### A.
	
If the stand is grown for an infinite number of rotations, what is the optimal rotation length when the initial age of the stand is zero?  Call this value $T^*$.  What is the present discounted value of net timber revenues from an infinite number of rotations?  Call this value $\pi_\infty$.

<span style="color: blue;">**Solution**</span>



```{r}


#Use this options list
options=list("algorithm"="NLOPT_LN_COBYLA",xtol_rel=1e-15,maxeval=16000)


```



### B.

Suppose that the initial age of the stand is A and $T_1$ is the additional number of years the stand is grown until harvest.  Then, $A+T_1$ is the age of the stand at the end of the first rotation. Assuming the first rotation is followed by an infinite number of rotations, write an expression for present discounted value of net timber revenues from an infinite number of rotations (including the first one).

<span style="color: blue;">**Solution**</span>



### C.

Using your formula in b, and assuming A=30, what is the optimal value of $T_1$? How does your answer change when A=40?  A=60.14?  A=90?  Make a table showing your results.

<span style="color: blue;">**Solution**</span>



```{r}


```

### D.

What do you notice about $A+T_1$?  Explain.

<span style="color: blue;">**Solution**</span>





